<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verio - Presupuesto por Servicios de Ac칰stica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --cream: #F5F0E8; --cream-light: #FAF8F4; --sage: #8B9D77; --sage-light: #A8B796; --sage-dark: #6B7D5A;
            --terracotta: #C4785A; --terracotta-light: #D4937A; --terracotta-dark: #A45A3C;
            --burgundy: #722F37; --burgundy-light: #8B4049; --burgundy-dark: #5A252C;
            --charcoal: #2D2D2D; --charcoal-light: #4A4A4A; --shadow: rgba(45, 45, 45, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: linear-gradient(145deg, var(--cream) 0%, var(--cream-light) 50%, #EDE8DF 100%); min-height: 100vh; color: var(--charcoal); line-height: 1.6; }
        .app-container { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
        header { text-align: center; margin-bottom: 2rem; position: relative; }
        header::before { content: ''; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background: linear-gradient(90deg, var(--sage), var(--terracotta)); border-radius: 2px; }
        h1 { font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; font-weight: 600; color: var(--burgundy); letter-spacing: -0.02em; margin-bottom: 0.5rem; }
        .subtitle { font-size: 0.95rem; color: var(--charcoal-light); }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: white; padding: 0.5rem; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); }
        .tab { flex: 1; padding: 0.75rem 1rem; border: none; background: transparent; font-family: 'Source Sans 3', sans-serif; font-size: 0.9rem; font-weight: 500; color: var(--charcoal-light); cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .tab:hover { background: var(--cream); }
        .tab.active { background: var(--burgundy); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .toolbar { display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); }
        .btn { padding: 0.6rem 1.2rem; font-family: 'Source Sans 3', sans-serif; font-size: 0.85rem; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--burgundy); color: white; }
        .btn-primary:hover { background: var(--burgundy-light); transform: translateY(-1px); }
        .btn-secondary { background: var(--sage); color: white; }
        .btn-secondary:hover { background: var(--sage-dark); }
        .btn-outline { background: transparent; border: 1.5px solid var(--terracotta); color: var(--terracotta); }
        .btn-outline:hover { background: var(--terracotta); color: white; }
        .btn-ghost { background: var(--cream); color: var(--charcoal); }
        .btn-ghost:hover { background: #E8E3DB; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .section { background: white; border-radius: 16px; margin-bottom: 1.5rem; box-shadow: 0 4px 20px var(--shadow); overflow: hidden; }
        .section.collapsed .section-body { display: none; }
        .section.collapsed .collapse-icon { transform: rotate(-90deg); }
        .section-header { background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-dark) 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .section-header.sage { background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%); }
        .section-header.terracotta { background: linear-gradient(135deg, var(--terracotta) 0%, var(--terracotta-dark) 100%); }
        .section-header.charcoal { background: linear-gradient(135deg, var(--charcoal) 0%, #1a1a1a 100%); }
        .section-header-left { display: flex; align-items: center; gap: 0.75rem; }
        .collapse-icon { width: 20px; height: 20px; transition: transform 0.2s; }
        .section-title { font-family: 'Cormorant Garamond', serif; font-size: 1.25rem; font-weight: 600; }
        .section-subtitle { font-size: 0.75rem; opacity: 0.85; }
        .btn-add { padding: 0.4rem 0.8rem; font-size: 0.8rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .btn-add:hover { background: rgba(255,255,255,0.3); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--cream); padding: 0.75rem 1rem; text-align: left; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--charcoal-light); border-bottom: 2px solid #E8E3DB; }
        th:nth-child(1) { width: 45%; } th:nth-child(2) { width: 12%; text-align: center; } th:nth-child(3) { width: 18%; text-align: right; } th:nth-child(4) { width: 18%; text-align: right; } th:nth-child(5) { width: 7%; text-align: center; }
        td { padding: 0.6rem 1rem; border-bottom: 1px solid #F0EBE3; vertical-align: middle; }
        tr:hover { background: var(--cream-light); }
        tr.subtotal-row { background: linear-gradient(90deg, #F8F5F0 0%, #F0EBE3 100%); }
        tr.subtotal-row td { font-weight: 600; color: var(--burgundy); border-bottom: 2px solid var(--sage-light); }
        tr.total-row { background: linear-gradient(90deg, var(--burgundy) 0%, var(--burgundy-dark) 100%); }
        tr.total-row td { color: white; font-weight: 600; font-size: 1.05rem; border-bottom: none; padding: 1rem; }
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 0.5rem 0.7rem; border: 1.5px solid #E0DBD3; border-radius: 6px; font-family: 'Source Sans 3', sans-serif; font-size: 0.9rem; transition: all 0.2s; background: white; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--sage); box-shadow: 0 0 0 3px rgba(139, 157, 119, 0.15); }
        input[type="number"] { text-align: right; }
        .input-cant { text-align: center; width: 70px; margin: 0 auto; display: block; }
        .price-final { font-weight: 600; color: var(--burgundy); text-align: right; font-size: 0.95rem; }
        .btn-delete { width: 28px; height: 28px; border: none; background: #FEE2E2; color: #DC2626; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-delete:hover { background: #DC2626; color: white; }
        .info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem; padding: 1.5rem; }
        .info-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .info-group.full-width { grid-column: 1 / -1; }
        .info-group.half-width { grid-column: span 2; }
        .info-label { font-size: 0.8rem; font-weight: 600; color: var(--charcoal-light); text-transform: uppercase; letter-spacing: 0.04em; }
        .info-input { padding: 0.7rem 1rem; border: 1.5px solid #E0DBD3; border-radius: 8px; font-size: 1rem; }
        textarea.info-input { min-height: 100px; resize: vertical; }
        .status-select { padding: 0.5rem 1rem; font-weight: 500; border-radius: 20px; border: none; cursor: pointer; }
        .status-borrador { background: #E5E7EB; color: #374151; }
        .status-enviado { background: #DBEAFE; color: #1D4ED8; }
        .status-aprobado { background: #D1FAE5; color: #047857; }
        .status-rechazado { background: #FEE2E2; color: #DC2626; }
        .status-facturado { background: #F3E8FF; color: #7C3AED; }
        .percentage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 1.5rem; }
        .percentage-item { display: flex; flex-direction: column; gap: 0.4rem; }
        .percentage-input { display: flex; align-items: center; gap: 0.5rem; }
        .percentage-input input { width: 80px; text-align: center; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: white; border-radius: 8px; border-left: 3px solid var(--sage); }
        .summary-item.highlight { border-left-color: var(--terracotta); background: linear-gradient(90deg, #FEF7F5 0%, white 100%); }
        .summary-item.total { grid-column: 1 / -1; background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-dark) 100%); border: none; padding: 1.25rem 1.5rem; }
        .summary-label { font-size: 0.9rem; color: var(--charcoal-light); }
        .summary-value { font-weight: 600; font-size: 1.1rem; color: var(--charcoal); }
        .summary-item.total .summary-label { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; font-weight: 600; color: white; }
        .summary-item.total .summary-value { font-size: 1.8rem; color: white; }
        .company-grid { display: grid; grid-template-columns: 150px 1fr; gap: 2rem; padding: 1.5rem; align-items: start; }
        .logo-upload { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .logo-preview { width: 120px; height: 120px; border: 2px dashed #E0DBD3; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: var(--cream-light); }
        .logo-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .logo-preview-placeholder { color: var(--charcoal-light); font-size: 0.8rem; text-align: center; }
        .company-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .calculator-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; padding: 1.5rem; }
        .calc-card { background: var(--cream-light); border-radius: 12px; padding: 1.25rem; }
        .calc-title { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; font-weight: 600; color: var(--burgundy); margin-bottom: 1rem; }
        .calc-row { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; align-items: center; }
        .calc-row label { font-size: 0.85rem; color: var(--charcoal-light); min-width: 80px; }
        .calc-row input, .calc-row select { flex: 1; }
        .calc-result { margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; text-align: center; }
        .calc-result-value { font-size: 1.5rem; font-weight: 600; color: var(--burgundy); }
        .calc-result-label { font-size: 0.8rem; color: var(--charcoal-light); }
        .search-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .search-input-wrapper { flex: 1; min-width: 200px; position: relative; }
        .search-input-wrapper input { padding-left: 2.5rem; }
        .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--charcoal-light); }
        .filter-group { display: flex; gap: 0.5rem; align-items: center; }
        .filter-group select { width: auto; min-width: 140px; }
        .saved-list { max-height: 400px; overflow-y: auto; }
        .saved-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #F0EBE3; cursor: pointer; transition: all 0.2s; }
        .saved-item:hover { background: var(--cream-light); }
        .saved-item-info { flex: 1; }
        .saved-item-name { font-weight: 500; color: var(--charcoal); margin-bottom: 0.25rem; }
        .saved-item-meta { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--charcoal-light); }
        .saved-item-status { padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 500; }
        .saved-item-actions { display: flex; gap: 0.5rem; }
        .btn-icon { width: 32px; height: 32px; border: none; background: var(--cream); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon:hover { background: #E8E3DB; }
        .btn-icon.danger:hover { background: #FEE2E2; color: #DC2626; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 45, 45, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; transform: translateY(20px); transition: all 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal.large { max-width: 800px; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #E8E3DB; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1; }
        .modal-title { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; font-weight: 600; color: var(--burgundy); }
        .modal-close { width: 32px; height: 32px; border: none; background: var(--cream); border-radius: 8px; cursor: pointer; font-size: 1.2rem; color: var(--charcoal-light); }
        .modal-close:hover { background: #E8E3DB; color: var(--burgundy); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; background: var(--cream-light); display: flex; gap: 0.75rem; justify-content: flex-end; position: sticky; bottom: 0; }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); padding: 1rem 1.5rem; background: var(--charcoal); color: white; border-radius: 10px; font-size: 0.9rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1001; opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--sage-dark); }
        .toast.error { background: var(--burgundy); }
        .icon { width: 16px; height: 16px; }
        .icon-sm { width: 14px; height: 14px; }
        .empty-state { text-align: center; padding: 3rem; color: var(--charcoal-light); }
        .price-history-list { max-height: 300px; overflow-y: auto; }
        .price-history-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #F0EBE3; }
        .price-history-change { font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .price-up { background: #FEE2E2; color: #DC2626; }
        .price-down { background: #D1FAE5; color: #047857; }
        /* CSS Nuevos para toggles y avisos */
        .btn-taller-toggle { cursor:pointer; font-size:0.7rem; display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 4px; margin-top: 4px; font-weight: 600; letter-spacing: 0.03em;}
        .taller-on { background: #D1FAE5; color: #065F46; border: 1px solid #A7F3D0; }
        .taller-off { background: #F3F4F6; color: #9CA3AF; border: 1px solid #E5E7EB; }
        @media (max-width: 900px) { .info-grid { grid-template-columns: repeat(2, 1fr); } .percentage-grid { grid-template-columns: repeat(2, 1fr); } .calculator-grid { grid-template-columns: 1fr; } .company-grid { grid-template-columns: 1fr; } .company-fields { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .app-container { padding: 1rem 0.75rem 3rem; } h1 { font-size: 1.8rem; } .tabs { flex-wrap: wrap; } .tab { flex: 1 1 45%; } .summary-grid { grid-template-columns: 1fr; } th, td { padding: 0.5rem 0.6rem; font-size: 0.85rem; } .input-cant { width: 55px; } .search-bar { flex-direction: column; } }
        @media (max-width: 500px) { .info-grid { grid-template-columns: 1fr; } .percentage-grid { grid-template-columns: 1fr; } }
        @media print { body { background: white; } .tabs, .toolbar, .btn-add, .btn-delete, .modal-overlay, .btn-taller-toggle { display: none !important; } .section { box-shadow: none; border: 1px solid #ddd; } .section.collapsed .section-body { display: block !important; } .collapse-icon { display: none; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header><h1>Verio</h1><p class="subtitle">Presupuesto por Servicios de Ac칰stica</p></header>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('presupuesto')">Presupuesto</button>
            <button class="tab" onclick="switchTab('guardados')">Base de Datos</button>
            <button class="tab" onclick="switchTab('calculadora')">Calculadora</button>
            <button class="tab" onclick="switchTab('configuracion')">Configuraci칩n</button>
        </div>
        <!-- TAB: PRESUPUESTO -->
        <div class="tab-content active" id="tab-presupuesto">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="openSaveModal()"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>Guardar</button>
                <button class="btn btn-secondary" onclick="switchTab('guardados')"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Cargar</button>
                <button class="btn btn-outline" onclick="exportPDF()"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>PDF</button>
                <button class="btn btn-ghost" onclick="duplicateCurrent()"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>Duplicar</button>
                <button class="btn btn-ghost" onclick="resetBudget()"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Reiniciar</button>
            </div>
            <section class="section">
                <div class="section-header charcoal" onclick="toggleSection(this)">
                    <div class="section-header-left"><svg class="collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><div><div class="section-title">Informaci칩n del Presupuesto</div><div class="section-subtitle">Datos del cliente</div></div></div>
                </div>
                <div class="section-body">
                    <div class="info-grid">
                        <div class="info-group"><label class="info-label">N췈 de Presupuesto</label><input type="text" class="info-input" id="numeroPresupuesto" placeholder="2026-001" onchange="updateClientInfo()"></div>
                        <div class="info-group"><label class="info-label">Fecha</label><input type="date" class="info-input" id="fechaPresupuesto" onchange="updateClientInfo()"></div>
                        <div class="info-group"><label class="info-label">Estado</label><select class="info-input status-select" id="estadoPresupuesto" onchange="updateStatus(this)"><option value="borrador">Borrador</option><option value="enviado">Enviado</option><option value="aprobado">Aprobado</option><option value="rechazado">Rechazado</option><option value="facturado">Facturado</option></select></div>
                        <div class="info-group"><label class="info-label">Validez del Presupuesto (D칤as)</label><input type="number" class="info-input" id="validezPresupuesto" value="30" onchange="updateClientInfo()"></div>
                        <div class="info-group"><label class="info-label">Nombre</label><input type="text" class="info-input" id="nombreCliente" placeholder="Nombre" onchange="updateClientInfo()"></div>
                        <div class="info-group"><label class="info-label">Apellido</label><input type="text" class="info-input" id="apellidoCliente" placeholder="Apellido" onchange="updateClientInfo()"></div>
                        <div class="info-group half-width"><label class="info-label">Email</label><input type="email" class="info-input" id="emailCliente" placeholder="email@ejemplo.com" onchange="updateClientInfo()"></div>
                        <div class="info-group full-width"><label class="info-label">Observaciones / Condiciones</label><textarea class="info-input" id="observaciones" placeholder="Condiciones de pago, plazos..." onchange="updateClientInfo()"></textarea></div>
                    </div>
                </div>
            </section>
            <section class="section">
                <div class="section-header sage" onclick="toggleSection(this)">
                    <div class="section-header-left"><svg class="collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><div><div class="section-title">Configuraci칩n de M치rgenes</div><div class="section-subtitle">Porcentajes</div></div></div>
                </div>
                <div class="section-body">
                    <div class="percentage-grid">
                        <div class="percentage-item"><label class="info-label">Gastos Indefinidos</label><div class="percentage-input"><input type="number" id="pctGastosIndef" value="5" min="0" max="100" onchange="updatePercentages(); calculateAll()"> %</div></div>
                        <div class="percentage-item"><label class="info-label">Gastos Mantenimiento</label><div class="percentage-input"><input type="number" id="pctMantenimiento" value="5" min="0" max="100" onchange="updatePercentages(); calculateAll()"> %</div></div>
                        <div class="percentage-item"><label class="info-label">Reposici칩n Materiales</label><div class="percentage-input"><input type="number" id="pctReposicion" value="10" min="0" max="100" onchange="updatePercentages(); calculateAll()"> %</div></div>
                        <div class="percentage-item"><label class="info-label">Ganancia</label><div class="percentage-input"><input type="number" id="pctGanancia" value="45" min="0" max="100" onchange="updatePercentages(); calculateAll()"> %</div></div>
                        <div class="percentage-item"><label class="info-label">Gasto Taller (por jornada)</label><div class="percentage-input">$ <input type="number" id="gastoTallerVal" value="35000" min="0" onchange="updatePercentages(); calculateAll()"></div></div>
                    </div>
                </div>
            </section>
            <section class="section" id="materialesSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-header-left"><svg class="collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><div><div class="section-title">Materiales</div><div class="section-subtitle">Madera, MDF, Aglomerado, Pintura</div></div></div>
                    <button class="btn-add" onclick="event.stopPropagation(); addRow('materiales')">+ Agregar</button>
                </div>
                <div class="section-body"><div class="table-container"><table><thead><tr><th>Descripci칩n</th><th>Cant.</th><th>$ Unitario</th><th>$ Final</th><th></th></tr></thead><tbody id="materialesBody"></tbody>
                <tfoot><tr class="subtotal-row"><td colspan="3">SUBTOTAL MATERIALES</td><td class="price-final" id="subtotalMateriales">$0</td><td></td></tr><tr><td colspan="3" style="color: var(--charcoal-light);">Gastos indefinidos (<span id="pctGastosIndefLabel">5</span>%)</td><td id="gastosMateriales">$0</td><td></td></tr><tr class="total-row"><td colspan="3">TOTAL MATERIALES</td><td id="totalMateriales">$0</td><td></td></tr></tfoot></table></div></div>
            </section>
            <section class="section" id="telasSection">
                <div class="section-header sage" onclick="toggleSection(this)">
                    <div class="section-header-left"><svg class="collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><div><div class="section-title">Telas</div><div class="section-subtitle">Panam치, Tropical Mec치nico</div></div></div>
                    <button class="btn-add" onclick="event.stopPropagation(); addRow('telas')">+ Agregar</button>
                </div>
                <div class="section-body"><div class="table-container"><table><thead><tr><th>Descripci칩n</th><th>Cant.</th><th>$ Unitario</th><th>$ Final</th><th></th></tr></thead><tbody id="telasBody"></tbody><tfoot><tr class="total-row" style="background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);"><td colspan="3">TOTAL TELAS</td><td id="totalTelas">$0</td><td></td></tr></tfoot></table></div></div>
            </section>
            <section class="section" id="jornadasSection">
                <div class="section-header terracotta" onclick="toggleSection(this)">
                    <div class="section-header-left"><svg class="collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><div><div class="section-title">Jornadas</div><div class="section-subtitle">Mano de Obra</div></div></div>
                    <button class="btn-add" onclick="event.stopPropagation(); addRow('jornadas')">+ Agregar</button>
                </div>
                <div class="section-body"><div class="table-container"><table><thead><tr><th>Descripci칩n</th><th>Cant.</th><th>$ Unitario</th><th>$ Final</th><th></th></tr></thead><tbody id="jornadasBody"></tbody><tfoot><tr class="total-row" style="background: linear-gradient(135deg, var(--terracotta) 0%, var(--terracotta-dark) 100%);"><td colspan="3">TOTAL JORNADAS</td><td id="totalJornadas">$0</td><td></td></tr></tfoot></table></div></div>
            </section>
            <section class="section" id="fletesSection">
                <div class="section-header charcoal" onclick="toggleSection(this)">
                    <div class="section-header-left"><svg class="collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><div><div class="section-title">Fletes</div><div class="section-subtitle">Transporte</div></div></div>
                    <button class="btn-add" onclick="event.stopPropagation(); addRow('fletes')">+ Agregar</button>
                </div>
                <div class="section-body"><div class="table-container"><table><thead><tr><th>Descripci칩n</th><th>Cant.</th><th>$ Unitario</th><th>$ Final</th><th></th></tr></thead><tbody id="fletesBody"></tbody><tfoot><tr class="total-row" style="background: linear-gradient(135deg, var(--charcoal) 0%, #1a1a1a 100%);"><td colspan="3">TOTAL FLETES</td><td id="totalFletes">$0</td><td></td></tr></tfoot></table></div></div>
            </section>
            <section class="section">
                <div class="section-header" style="background: linear-gradient(135deg, var(--burgundy) 0%, #4A1D22 100%);"><div class="section-header-left"><div><div class="section-title">Resumen</div><div class="section-subtitle">C치lculos Finales</div></div></div></div>
                <div class="section-body">
                    <div class="summary-grid">
                        <div class="summary-item"><span class="summary-label">Total Materiales</span><span class="summary-value" id="resumenMateriales">$0</span></div>
                        <div class="summary-item"><span class="summary-label">Gastos Mant. (<span id="pctMantLabel">5</span>%)</span><span class="summary-value" id="resumenMantenimiento">$0</span></div>
                        <div class="summary-item"><span class="summary-label">Reposici칩n (<span id="pctRepoLabel">10</span>%)</span><span class="summary-value" id="resumenReposicion">$0</span></div>
                        <div class="summary-item highlight"><span class="summary-label">Gastos Taller</span><span class="summary-value" id="resumenTaller">$0</span></div>
                        <div class="summary-item"><span class="summary-label">Total Telas</span><span class="summary-value" id="resumenTelas">$0</span></div>
                        <div class="summary-item"><span class="summary-label">Total Jornadas</span><span class="summary-value" id="resumenJornadas">$0</span></div>
                        <div class="summary-item highlight"><span class="summary-label">Subtotal</span><span class="summary-value" id="resumenSubtotal">$0</span></div>
                        <div class="summary-item highlight"><span class="summary-label">Ganancia (<span id="pctGanLabel">45</span>%)</span><span class="summary-value" id="resumenGanancia">$0</span></div>
                        <div class="summary-item"><span class="summary-label">Fletes</span><span class="summary-value" id="resumenFletes">$0</span></div>
                        <div class="summary-item total"><span class="summary-label">TOTAL PRESUPUESTO</span><span class="summary-value" id="totalFinal">$0</span></div>
                    </div>
                </div>
            </section>
        </div>
        <!-- TAB: GUARDADOS -->
        <div class="tab-content" id="tab-guardados">
            <div class="section">
                <div class="section-header charcoal"><div><div class="section-title">Presupuestos Guardados</div><div class="section-subtitle">Buscar y gestionar</div></div></div>
                <div class="section-body" style="padding: 1.5rem;">
                    <div class="search-bar">
                        <div class="search-input-wrapper"><svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="searchInput" placeholder="Buscar..." oninput="filterSavedList()"></div>
                        <div class="filter-group"><select id="filterStatus" onchange="filterSavedList()"><option value="">Todos</option><option value="borrador">Borrador</option><option value="enviado">Enviado</option><option value="aprobado">Aprobado</option><option value="rechazado">Rechazado</option><option value="facturado">Facturado</option></select></div>
                        <div class="filter-group"><input type="date" id="filterDateFrom" onchange="filterSavedList()" title="Desde"><span>-</span><input type="date" id="filterDateTo" onchange="filterSavedList()" title="Hasta"></div>
                    </div>
                    <div class="saved-list" id="savedListContainer"></div>
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E8E3DB; display: flex; gap: 0.75rem; justify-content: center;">
                        <button class="btn btn-outline" onclick="exportAllJSON()"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Exportar JSON</button>
                        <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Importar JSON</button>
                        <input type="file" id="importFile" accept=".json" style="display: none" onchange="importJSON(event)">
                    </div>
                </div>
            </div>
        </div>
        <!-- TAB: CALCULADORA -->
        <div class="tab-content" id="tab-calculadora">
            <div class="section">
                <div class="section-header sage"><div><div class="section-title">Calculadora de Materiales</div></div></div>
                <div class="section-body">
                    <div class="calculator-grid">
                        <div class="calc-card">
                            <div class="calc-title">游늻 Placas de MDF</div>
                            <p style="font-size: 0.85rem; color: var(--charcoal-light); margin-bottom: 1rem;">Placa: 2.60m x 1.83m = 4.76 m</p>
                            <div class="calc-row"><label>Ancho (m):</label><input type="number" id="calcMdfAncho" step="0.01" value="0" oninput="calcMdf()"></div>
                            <div class="calc-row"><label>Alto (m):</label><input type="number" id="calcMdfAlto" step="0.01" value="0" oninput="calcMdf()"></div>
                            <div class="calc-row"><label>Cantidad:</label><input type="number" id="calcMdfCant" value="1" oninput="calcMdf()"></div>
                            <div class="calc-result"><div class="calc-result-value" id="calcMdfResult">0</div><div class="calc-result-label">placas necesarias</div></div>
                            <div class="calc-result" style="margin-top: 0.5rem;"><div class="calc-result-value" id="calcMdfM2">0 m</div><div class="calc-result-label">superficie total</div></div>
                        </div>
                        <div class="calc-card">
                            <div class="calc-title">游늺 Tapacanto</div>
                            <div class="calc-row"><label>Ancho (m):</label><input type="number" id="calcTapaAncho" step="0.01" value="0" oninput="calcTapacanto()"></div>
                            <div class="calc-row"><label>Alto (m):</label><input type="number" id="calcTapaAlto" step="0.01" value="0" oninput="calcTapacanto()"></div>
                            <div class="calc-row"><label>Cantidad:</label><input type="number" id="calcTapaCant" value="1" oninput="calcTapacanto()"></div>
                            <div class="calc-row"><label>Cantos:</label><select id="calcTapaCantos" onchange="calcTapacanto()"><option value="4">4 lados</option><option value="2h">2 horizontales</option><option value="2v">2 verticales</option><option value="1">1 lado</option></select></div>
                            <div class="calc-result"><div class="calc-result-value" id="calcTapaResult">0 m</div><div class="calc-result-label">metros lineales</div></div>
                        </div>
                        <div class="calc-card">
                            <div class="calc-title">游빗 Tela</div>
                            <div class="calc-row"><label>Ancho (m):</label><input type="number" id="calcTelaAncho" step="0.01" value="0" oninput="calcTela()"></div>
                            <div class="calc-row"><label>Alto (m):</label><input type="number" id="calcTelaAlto" step="0.01" value="0" oninput="calcTela()"></div>
                            <div class="calc-row"><label>Cantidad:</label><input type="number" id="calcTelaCant" value="1" oninput="calcTela()"></div>
                            <div class="calc-row"><label>Margen (cm):</label><input type="number" id="calcTelaMargen" value="5" oninput="calcTela()"></div>
                            <div class="calc-result"><div class="calc-result-value" id="calcTelaResult">0 m</div><div class="calc-result-label">metros cuadrados</div></div>
                        </div>
                        <div class="calc-card">
                            <div class="calc-title">游댉 Material Fono Absorbente</div>
                            <p style="font-size: 0.85rem; color: var(--charcoal-light); margin-bottom: 1rem;">Rollo: 18m</p>
                            <div class="calc-row"><label>Superficie:</label><input type="number" id="calcLanaM2" step="0.1" value="0" oninput="calcLana()"></div>
                            <div class="calc-row"><label>Capas:</label><input type="number" id="calcLanaCapas" value="1" oninput="calcLana()"></div>
                            <div class="calc-result"><div class="calc-result-value" id="calcLanaResult">0</div><div class="calc-result-label">rollos necesarios</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- TAB: CONFIGURACI칍N -->
        <div class="tab-content" id="tab-configuracion">
            <div class="section">
                <div class="section-header"><div><div class="section-title">Datos de la Empresa</div></div></div>
                <div class="section-body">
                    <div class="company-grid">
                        <div class="logo-upload">
                            <div class="logo-preview" id="logoPreview"><span class="logo-preview-placeholder">Logo</span></div>
                            <button class="btn btn-small btn-ghost" onclick="document.getElementById('logoInput').click()">Subir Logo</button>
                            <input type="file" id="logoInput" accept="image/*" style="display: none" onchange="handleLogoUpload(event)">
                            <button class="btn btn-small btn-ghost" onclick="removeLogo()" style="font-size: 0.75rem;">Quitar</button>
                            <div style="font-size: 0.7rem; color: #666; text-align: center; margin-top:5px;">M치x: 1MB</div>
                        </div>
                        <div class="company-fields">
                            <div class="info-group"><label class="info-label">Nombre</label><input type="text" class="info-input" id="empresaNombre" placeholder="Herramientas Ac칰sticas" onchange="saveCompanyData()"></div>
                            <div class="info-group"><label class="info-label">CUIT</label><input type="text" class="info-input" id="empresaCuit" placeholder="20-12345678-9" onchange="saveCompanyData()"></div>
                            <div class="info-group"><label class="info-label">Direcci칩n</label><input type="text" class="info-input" id="empresaDireccion" placeholder="Calle 123" onchange="saveCompanyData()"></div>
                            <div class="info-group"><label class="info-label">Tel칠fono</label><input type="tel" class="info-input" id="empresaTelefono" placeholder="+54 11 1234-5678" onchange="saveCompanyData()"></div>
                            <div class="info-group"><label class="info-label">Email</label><input type="email" class="info-input" id="empresaEmail" placeholder="contacto@empresa.com" onchange="saveCompanyData()"></div>
                            <div class="info-group"><label class="info-label">Web</label><input type="text" class="info-input" id="empresaWeb" placeholder="www.empresa.com" onchange="saveCompanyData()"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI칍N NUEVA: GESTI칍N DE CAT츼LOGO BASE (Visualmente integrada al dise침o) -->
             <div class="section">
                <div class="section-header charcoal"><div><div class="section-title">Gesti칩n de Precios Base</div><div class="section-subtitle">Define con qu칠 valores inicia la aplicaci칩n</div></div></div>
                <div class="section-body" style="padding: 1.5rem;">
                    <p style="font-size: 0.9rem; color: var(--charcoal-light); margin-bottom: 1rem;">
                        Configura la lista de precios ideal en la pesta침a <strong>Presupuesto</strong>. Luego, guarda aqu칤 para que futuros presupuestos inicien con esos valores.
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="saveCurrentStateAsBase()">Guardar Precios Actuales como Base</button>
                        <button class="btn btn-outline" onclick="resetBaseToFactory()">Restaurar Valores de F치brica</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header terracotta"><div><div class="section-title">Historial de Precios</div></div><button class="btn-add" onclick="openPriceHistoryModal()">Ver</button></div>
                <div class="section-body" style="padding: 1.5rem;">
                    <p style="color: var(--charcoal-light);">Los cambios de precio se guardan autom치ticamente.</p>
                    <button class="btn btn-outline" style="margin-top: 1rem;" onclick="updateAllPrices()">Registrar Precios Actuales</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Guardar -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Guardar Presupuesto</h3><button class="modal-close" onclick="closeModal('saveModal')">칑</button></div>
            <div class="modal-body"><div class="info-group"><label class="info-label">Nombre</label><input type="text" class="info-input" id="saveName" placeholder="Estudio Pedro - Enero 2026"></div></div>
            <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('saveModal')">Cancelar</button><button class="btn btn-primary" onclick="saveBudget()">Guardar</button></div>
        </div>
    </div>
    <!-- Modal Historial -->
    <div class="modal-overlay" id="priceHistoryModal">
        <div class="modal large">
            <div class="modal-header"><h3 class="modal-title">Historial de Precios</h3><button class="modal-close" onclick="closeModal('priceHistoryModal')">칑</button></div>
            <div class="modal-body">
                <div class="search-bar" style="margin-bottom: 1rem;"><div class="search-input-wrapper" style="flex: 1;"><svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="priceHistorySearch" placeholder="Buscar material..." oninput="filterPriceHistory()"></div></div>
                <div class="price-history-list" id="priceHistoryList"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('priceHistoryModal')">Cerrar</button></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script>
        // DATOS DE F츼BRICA (Respaldo original)
        const factoryData = {
            materiales: [
                { desc: 'MDF 18 crudo', precio: 60000 },{ desc: 'MDF 15 crudo', precio: 56000 },{ desc: 'MDF 12 crudo', precio: 39000 },
                { desc: 'MDF 9 crudo', precio: 31000 },{ desc: 'MDF 5,5 crudo', precio: 25000 },{ desc: 'MDF 3 crudo', precio: 20000 },
                { desc: 'Aglomerado 18mm enchapado guatamb칰', precio: 155000 },{ desc: 'MDF 12mm enchapado guatamb칰 (2,70)', precio: 103000 },
                { desc: 'MDF 9mm enchapado', precio: 140000 },{ desc: 'MDF 5,5 enchapado 1 cara', precio: 73000 },
                { desc: 'MDF 5,5 enchapado 2 caras', precio: 109000 },{ desc: 'Tapacanto 22x50mt', precio: 650 },
                { desc: 'Tapacanto PVC', precio: 1000 },{ desc: 'Cortes', precio: 0 },{ desc: 'Guatamb칰 macizo tabla 19cm', precio: 0 },
                { desc: 'Laca', precio: 19000 },{ desc: 'Cola', precio: 5000 },{ desc: 'Pintura sint칠tica 1L', precio: 16000 },
                { desc: 'Lijas', precio: 1300 },{ desc: 'Lija de banda', precio: 4500 },{ desc: 'Cinta enmascarar', precio: 1500 },
                { desc: 'Pl치stico', precio: 8300 },{ desc: 'Grampas manual x1000', precio: 4000 },{ desc: 'Grapas neum치tica x5000', precio: 16000 },
                { desc: 'Clavos neum치tico', precio: 17000 },{ desc: 'Placas Acustiver P50', precio: 27000 },
                { desc: 'Acustiver R40 ancho', precio: 33000 },{ desc: 'Lana de rollo', precio: 5800 },
                { desc: 'Tech Slab 25mm (paquete x18)', precio: 7800 },{ desc: 'Tech Slab 25mm unidad', precio: 9200 },
                { desc: 'Tela friselina', precio: 800 },{ desc: 'Sistema colgado 12cm x2', precio: 500 },{ desc: 'Colgado nube', precio: 0 },
                { desc: 'Sistema colgado 60cm', precio: 0 },{ desc: 'Colgado nube pit칩n', precio: 26 },{ desc: 'Spots luces', precio: 10000 },
                { desc: '2 Resonadores', precio: 89000 },{ desc: '1 MLS pared 90x136', precio: 0 },{ desc: 'Material embalaje', precio: 9000 }
            ],
            telas: [{ desc: 'Tela panam치', precio: 16000 },{ desc: 'Tela tropical mec치nico 1,5', precio: 2000 }],
            jornadas: [{ desc: 'M칤as', precio: 70000 },{ desc: 'Compra tela y elementos', precio: 40000 },{ desc: 'Asistente', precio: 50000 },{ desc: 'Jornada instalaci칩n', precio: 0 }],
            fletes: [{ desc: 'F 100', precio: 70000 },{ desc: 'Flete mi Yant칟', precio: 22000 }]
        };

        let state = { materiales: [], telas: [], jornadas: [], fletes: [], clientInfo: { numero: '', fecha: '', estado: 'borrador', validez: 30, nombre: '', apellido: '', email: '', observaciones: '' }, percentages: { gastosIndef: 5, mantenimiento: 5, reposicion: 10, ganancia: 45, gastoTaller: 35000 } };
        let companyData = { nombre: '', cuit: '', direccion: '', telefono: '', email: '', web: '', logo: null };
        let priceHistory = {};

        // 1. FUNCI칍N ESCAPE HTML (Correcci칩n Seguridad Comillas)
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function init() { loadCompanyData(); loadPriceHistory(); loadInitialData(); initClientInfo(); renderAll(); calculateAll(); renderSavedList(); }
        
        // 2. FUNCI칍N CARGA DE DATOS (Mejora: Base Catalog Editada)
        function loadInitialData() {
            // Verificar si hay una base personalizada
            const storedBase = localStorage.getItem('verioBaseData');
            const sourceData = storedBase ? JSON.parse(storedBase) : factoryData;

            // Mapeamos generando IDs nuevos cada vez
            state.materiales = sourceData.materiales.map((item, i) => ({ id: `mat_${Date.now()}_${i}`, desc: item.desc, cant: 0, precio: item.precio }));
            state.telas = sourceData.telas.map((item, i) => ({ id: `tel_${Date.now()}_${i}`, desc: item.desc, cant: 0, precio: item.precio }));
            
            // L칩gica para jornadas (compatible con versiones anteriores y futuras)
            state.jornadas = sourceData.jornadas.map((item, i) => {
                // Si la base guardada tiene "aplicaTaller", 칰salo. Si no, infiere por el nombre (vieja l칩gica).
                let aplica = item.aplicaTaller;
                if (typeof aplica === 'undefined') {
                    aplica = (item.desc.toLowerCase().includes('m칤a') || item.desc.toLowerCase().includes('mia'));
                }
                return { 
                    id: `jor_${Date.now()}_${i}`, 
                    desc: item.desc, 
                    cant: 0, 
                    precio: item.precio,
                    aplicaTaller: aplica
                };
            });

            state.fletes = sourceData.fletes.map((item, i) => ({ id: `fle_${Date.now()}_${i}`, desc: item.desc, cant: 0, precio: item.precio }));
        }

        function initClientInfo() { const today = new Date().toISOString().split('T')[0]; document.getElementById('fechaPresupuesto').value = today; state.clientInfo.fecha = today; updateStatus(document.getElementById('estadoPresupuesto')); }
        function switchTab(tabName) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active'); document.getElementById(`tab-${tabName}`).classList.add('active'); if (tabName === 'guardados') renderSavedList(); }
        
        // FUNCI칍N COLAPSAR SECCIONES (Recuperada)
        function toggleSection(header) { header.closest('.section').classList.toggle('collapsed'); }
        
        function formatCurrency(num) { return '$' + Math.round(num).toLocaleString('es-AR'); }
        function formatDate(dateStr) { if (!dateStr) return ''; const d = new Date(dateStr + 'T00:00:00'); return d.toLocaleDateString('es-AR'); }

        function renderTable(section, data, bodyId) {
            const isJornadas = section === 'jornadas';
            document.getElementById(bodyId).innerHTML = data.map((item) => {
                // Bot칩n visual para taller (Correcci칩n l칩gica taller)
                const tallerToggle = isJornadas 
                    ? `<div class="btn-taller-toggle ${item.aplicaTaller ? 'taller-on' : 'taller-off'}" 
                         onclick="toggleTallerExpense('${item.id}')" title="Incluir en gastos de taller">
                         ${item.aplicaTaller ? '九 Taller Incluido' : '丘 No aplica Taller'}
                       </div>` 
                    : '';
                
                return `<tr data-id="${item.id}">
                    <td>
                        <input type="text" value="${escapeHtml(item.desc)}" onchange="updateItem('${section}', '${item.id}', 'desc', this.value)">
                        ${tallerToggle}
                    </td>
                    <td><input type="number" class="input-cant" value="${item.cant || ''}" min="0" step="1" onchange="updateItem('${section}', '${item.id}', 'cant', parseFloat(this.value) || 0)" placeholder="0"></td>
                    <td><input type="number" value="${item.precio || ''}" min="0" onchange="updatePrice('${section}', '${item.id}', parseFloat(this.value) || 0)" placeholder="0"></td>
                    <td class="price-final">${formatCurrency(item.cant * item.precio)}</td>
                    <td><button class="btn-delete" onclick="deleteItem('${section}', '${item.id}')" title="Eliminar">칑</button></td>
                </tr>`;
            }).join('');
        }
        function renderAll() { renderTable('materiales', state.materiales, 'materialesBody'); renderTable('telas', state.telas, 'telasBody'); renderTable('jornadas', state.jornadas, 'jornadasBody'); renderTable('fletes', state.fletes, 'fletesBody'); }
        
        function updateItem(section, id, field, value) { const item = state[section].find(i => i.id === id); if (item) { item[field] = value; renderAll(); calculateAll(); } }
        
        // Correcci칩n L칩gica Taller: Bot칩n Toggle
        function toggleTallerExpense(id) {
            const item = state.jornadas.find(i => i.id === id);
            if (item) {
                item.aplicaTaller = !item.aplicaTaller;
                renderAll(); 
                calculateAll();
            }
        }

        function updatePrice(section, id, newPrice) { const item = state[section].find(i => i.id === id); if (item) { const oldPrice = item.precio; item.precio = newPrice; if (oldPrice !== newPrice && newPrice > 0) addToPriceHistory(item.desc, oldPrice, newPrice); renderAll(); calculateAll(); } }
        function addRow(section) { state[section].push({ id: `${section}_${Date.now()}`, desc: 'Nuevo item', cant: 0, precio: 0, aplicaTaller: section==='jornadas' }); renderAll(); calculateAll(); }
        function deleteItem(section, id) { if(confirm("쮼liminar?")){ state[section] = state[section].filter(i => i.id !== id); renderAll(); calculateAll(); } }

        function updateClientInfo() { state.clientInfo.numero = document.getElementById('numeroPresupuesto').value; state.clientInfo.fecha = document.getElementById('fechaPresupuesto').value; state.clientInfo.estado = document.getElementById('estadoPresupuesto').value; state.clientInfo.validez = parseInt(document.getElementById('validezPresupuesto').value) || 30; state.clientInfo.nombre = document.getElementById('nombreCliente').value; state.clientInfo.apellido = document.getElementById('apellidoCliente').value; state.clientInfo.email = document.getElementById('emailCliente').value; state.clientInfo.observaciones = document.getElementById('observaciones').value; }
        function loadClientInfoToForm() { document.getElementById('numeroPresupuesto').value = state.clientInfo.numero || ''; document.getElementById('fechaPresupuesto').value = state.clientInfo.fecha || ''; document.getElementById('estadoPresupuesto').value = state.clientInfo.estado || 'borrador'; document.getElementById('validezPresupuesto').value = state.clientInfo.validez || 30; document.getElementById('nombreCliente').value = state.clientInfo.nombre || ''; document.getElementById('apellidoCliente').value = state.clientInfo.apellido || ''; document.getElementById('emailCliente').value = state.clientInfo.email || ''; document.getElementById('observaciones').value = state.clientInfo.observaciones || ''; updateStatus(document.getElementById('estadoPresupuesto')); }
        function updateStatus(select) { select.className = 'info-input status-select status-' + select.value; state.clientInfo.estado = select.value; }

        function updatePercentages() { state.percentages.gastosIndef = parseFloat(document.getElementById('pctGastosIndef').value) || 0; state.percentages.mantenimiento = parseFloat(document.getElementById('pctMantenimiento').value) || 0; state.percentages.reposicion = parseFloat(document.getElementById('pctReposicion').value) || 0; state.percentages.ganancia = parseFloat(document.getElementById('pctGanancia').value) || 0; state.percentages.gastoTaller = parseFloat(document.getElementById('gastoTallerVal').value) || 0; document.getElementById('pctGastosIndefLabel').textContent = state.percentages.gastosIndef; document.getElementById('pctMantLabel').textContent = state.percentages.mantenimiento; document.getElementById('pctRepoLabel').textContent = state.percentages.reposicion; document.getElementById('pctGanLabel').textContent = state.percentages.ganancia; }
        function loadPercentagesToForm() { document.getElementById('pctGastosIndef').value = state.percentages.gastosIndef; document.getElementById('pctMantenimiento').value = state.percentages.mantenimiento; document.getElementById('pctReposicion').value = state.percentages.reposicion; document.getElementById('pctGanancia').value = state.percentages.ganancia; document.getElementById('gastoTallerVal').value = state.percentages.gastoTaller; updatePercentages(); }

        function calculateAll() {
            const pct = state.percentages;
            const subtotalMat = state.materiales.reduce((sum, i) => sum + (i.cant * i.precio), 0);
            const gastosMat = subtotalMat * (pct.gastosIndef / 100);
            const totalMat = subtotalMat + gastosMat;
            document.getElementById('subtotalMateriales').textContent = formatCurrency(subtotalMat);
            document.getElementById('gastosMateriales').textContent = formatCurrency(gastosMat);
            document.getElementById('totalMateriales').textContent = formatCurrency(totalMat);
            const totalTelas = state.telas.reduce((sum, i) => sum + (i.cant * i.precio), 0);
            document.getElementById('totalTelas').textContent = formatCurrency(totalTelas);
            const totalJornadas = state.jornadas.reduce((sum, i) => sum + (i.cant * i.precio), 0);
            document.getElementById('totalJornadas').textContent = formatCurrency(totalJornadas);
            
            // Correcci칩n L칩gica Taller: Usa el booleano 'aplicaTaller'
            const jornadasTallerCant = state.jornadas.reduce((sum, j) => sum + (j.aplicaTaller ? j.cant : 0), 0);
            const gastosTaller = jornadasTallerCant * pct.gastoTaller;

            const totalFletes = state.fletes.reduce((sum, i) => sum + (i.cant * i.precio), 0);
            document.getElementById('totalFletes').textContent = formatCurrency(totalFletes);
            const mantenimiento = totalMat * (pct.mantenimiento / 100);
            const reposicion = totalMat * (pct.reposicion / 100);
            const subtotal = totalMat + mantenimiento + reposicion + gastosTaller + totalTelas + totalJornadas;
            const ganancia = subtotal * (pct.ganancia / 100);
            const totalFinal = subtotal + ganancia + totalFletes;
            document.getElementById('resumenMateriales').textContent = formatCurrency(totalMat);
            document.getElementById('resumenMantenimiento').textContent = formatCurrency(mantenimiento);
            document.getElementById('resumenReposicion').textContent = formatCurrency(reposicion);
            document.getElementById('resumenTaller').textContent = formatCurrency(gastosTaller);
            document.getElementById('resumenTelas').textContent = formatCurrency(totalTelas);
            document.getElementById('resumenJornadas').textContent = formatCurrency(totalJornadas);
            document.getElementById('resumenSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('resumenGanancia').textContent = formatCurrency(ganancia);
            document.getElementById('resumenFletes').textContent = formatCurrency(totalFletes);
            document.getElementById('totalFinal').textContent = formatCurrency(totalFinal);
        }

        // FUNCIONES DE LA SECCION NUEVA (CATALOGO BASE)
        function saveCurrentStateAsBase() {
            if(!confirm("쮻eseas guardar los 칤tems y precios de la tabla actual como tus valores por defecto? \n\nLas cantidades actuales NO se guardar치n (se reinician a cero).")) return;
            
            // Creamos un clon de los datos pero aseguramos cantidades en 0 y preservamos descripciones y flags
            const newBase = {
                materiales: state.materiales.map(i => ({desc: i.desc, precio: i.precio})),
                jornadas: state.jornadas.map(i => ({desc: i.desc, precio: i.precio, aplicaTaller: i.aplicaTaller})),
                telas: state.telas.map(i => ({desc: i.desc, precio: i.precio})),
                fletes: state.fletes.map(i => ({desc: i.desc, precio: i.precio}))
            };

            localStorage.setItem('verioBaseData', JSON.stringify(newBase));
            showToast('Base actualizada correctamente. Reinicia para ver cambios.', 'success');
        }

        function resetBaseToFactory() {
            if(!confirm("Restaurar valores de f치brica? Perder치s tus precios base personalizados.")) return;
            localStorage.removeItem('verioBaseData');
            showToast('Valores de f치brica restaurados. Reinicia.', 'success');
        }

        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        function openSaveModal() { const clientName = state.clientInfo.nombre && state.clientInfo.apellido ? `${state.clientInfo.apellido}, ${state.clientInfo.nombre}` : ''; document.getElementById('saveName').value = state.clientInfo.numero ? `${state.clientInfo.numero} - ${clientName}`.trim() : clientName; openModal('saveModal'); }
        function saveBudget() { const name = document.getElementById('saveName').value.trim(); if (!name) { showToast('Ingresa un nombre', 'error'); return; } updateClientInfo(); const saved = JSON.parse(localStorage.getItem('presupuestos') || '{}'); saved[name] = { state: JSON.parse(JSON.stringify(state)), date: new Date().toISOString() }; localStorage.setItem('presupuestos', JSON.stringify(saved)); closeModal('saveModal'); showToast('Guardado', 'success'); }
        
        function renderSavedList() {
            const saved = JSON.parse(localStorage.getItem('presupuestos') || '{}');
            const container = document.getElementById('savedListContainer');
            let entries = Object.entries(saved);
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const dateFrom = document.getElementById('filterDateFrom')?.value || '';
            const dateTo = document.getElementById('filterDateTo')?.value || '';
            entries = entries.filter(([name, data]) => {
                const s = data.state;
                const clientName = `${s.clientInfo?.nombre || ''} ${s.clientInfo?.apellido || ''}`.toLowerCase();
                const numero = (s.clientInfo?.numero || '').toLowerCase();
                const matchesSearch = !searchTerm || name.toLowerCase().includes(searchTerm) || clientName.includes(searchTerm) || numero.includes(searchTerm);
                const matchesStatus = !statusFilter || s.clientInfo?.estado === statusFilter;
                const budgetDate = s.clientInfo?.fecha || data.date.split('T')[0];
                return matchesSearch && matchesStatus && (!dateFrom || budgetDate >= dateFrom) && (!dateTo || budgetDate <= dateTo);
            });
            if (entries.length === 0) { container.innerHTML = '<div class="empty-state"><p>No hay presupuestos</p></div>'; return; }
            entries.sort((a, b) => new Date(b[1].date) - new Date(a[1].date));
            container.innerHTML = entries.map(([name, data]) => {
                const s = data.state; const estado = s.clientInfo?.estado || 'borrador';
                const clientName = s.clientInfo?.nombre && s.clientInfo?.apellido ? `${s.clientInfo.nombre} ${s.clientInfo.apellido}` : 'Sin cliente';
                
                // MEJORA: Duplicaci칩n Inteligente
                // Preparamos el nombre con escape de comillas para pasarlo a la funcion
                const escapedName = escapeHtml(name).replace(/'/g, "&apos;");

                return `<div class="saved-item"><div class="saved-item-info" onclick="loadBudget('${escapedName}')"><div class="saved-item-name">${escapeHtml(name)}</div><div class="saved-item-meta"><span>${escapeHtml(clientName)}</span><span>${formatDate(s.clientInfo?.fecha || data.date.split('T')[0])}</span><span class="saved-item-status status-${estado}">${estado.charAt(0).toUpperCase() + estado.slice(1)}</span></div></div><div class="saved-item-actions"><button class="btn-icon" onclick="event.stopPropagation(); duplicateSavedSmart('${escapedName}')" title="Duplicar"><svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button><button class="btn-icon danger" onclick="event.stopPropagation(); deleteSaved('${escapedName}')" title="Eliminar"><svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></div>`;
            }).join('');
        }
        function filterSavedList() { renderSavedList(); }

        // MEJORA: Carga segura y correccion de 'm칤a' para viejos
        function loadBudget(nameEncoded) { 
            const name = nameEncoded.replace(/&apos;/g, "'").replace(/&quot;/g, '"');
            const saved = JSON.parse(localStorage.getItem('presupuestos') || '{}'); 
            if (saved[name]) { 
                state = JSON.parse(JSON.stringify(saved[name].state)); 
                if (!state.clientInfo) state.clientInfo = { numero: '', fecha: '', estado: 'borrador', validez: 30, nombre: '', apellido: '', email: '', observaciones: '' }; 
                if (!state.percentages) state.percentages = { gastosIndef: 5, mantenimiento: 5, reposicion: 10, ganancia: 45, gastoTaller: 35000 }; 
                
                // Migraci칩n si el dato es viejo (pre-bot칩n)
                state.jornadas.forEach(j => {
                   if(j.aplicaTaller === undefined) j.aplicaTaller = (j.desc.toLowerCase().includes('m칤a') || j.desc.toLowerCase().includes('mia'));
                });

                loadClientInfoToForm(); loadPercentagesToForm(); renderAll(); calculateAll(); switchTab('presupuesto'); showToast('Cargado', 'success'); 
            } 
        }

        function deleteSaved(nameEncoded) { 
            const name = nameEncoded.replace(/&apos;/g, "'");
            if (!confirm(`쮼liminar "${name}"?`)) return; 
            const saved = JSON.parse(localStorage.getItem('presupuestos') || '{}'); 
            delete saved[name]; 
            localStorage.setItem('presupuestos', JSON.stringify(saved)); 
            renderSavedList(); showToast('Eliminado', 'success'); 
        }

        // MEJORA DUPLICACI칍N INTELIGENTE
        function duplicateSavedSmart(nameEncoded) { 
            const name = nameEncoded.replace(/&apos;/g, "'");
            const saved = JSON.parse(localStorage.getItem('presupuestos') || '{}'); 
            
            if (saved[name]) { 
                // Generar nombre copia 칰nico
                let newName = `${name} (copia)`;
                let counter = 2;
                while(saved[newName]) {
                    newName = `${name} (copia ${counter})`;
                    counter++;
                }

                const newState = JSON.parse(JSON.stringify(saved[name].state)); 
                newState.clientInfo.estado = 'borrador'; 
                newState.clientInfo.numero = ''; 
                saved[newName] = { state: newState, date: new Date().toISOString() }; 
                localStorage.setItem('presupuestos', JSON.stringify(saved)); 
                renderSavedList(); 
                showToast(`Duplicado como: ${newName}`, 'success'); 
            } 
        }
        
        function duplicateCurrent() { updateClientInfo(); state.clientInfo.estado = 'borrador'; state.clientInfo.numero = ''; state.clientInfo.fecha = new Date().toISOString().split('T')[0]; loadClientInfoToForm(); showToast('Duplicado - gu치rdalo con nuevo nombre', 'success'); }
        function resetBudget() { if (!confirm('Reiniciar cantidades a cero? (Se cargar치n precios de tu base guardada)')) return; loadInitialData(); renderAll(); calculateAll(); showToast('Reiniciado', 'success'); }

        function exportAllJSON() { const exportData = { baseData: localStorage.getItem('verioBaseData') ? JSON.parse(localStorage.getItem('verioBaseData')) : null, presupuestos: JSON.parse(localStorage.getItem('presupuestos') || '{}'), companyData: JSON.parse(localStorage.getItem('companyData') || '{}'), priceHistory: JSON.parse(localStorage.getItem('priceHistory') || '{}'), exportDate: new Date().toISOString() }; const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); showToast('Exportado', 'success'); }
        function importJSON(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.presupuestos) { const existing = JSON.parse(localStorage.getItem('presupuestos') || '{}'); localStorage.setItem('presupuestos', JSON.stringify({ ...existing, ...data.presupuestos })); } if (data.companyData) { localStorage.setItem('companyData', JSON.stringify(data.companyData)); loadCompanyData(); } if(data.baseData) { localStorage.setItem('verioBaseData', JSON.stringify(data.baseData)); } if (data.priceHistory) { const existing = JSON.parse(localStorage.getItem('priceHistory') || '{}'); for (const [key, history] of Object.entries(data.priceHistory)) { if (!existing[key]) existing[key] = []; existing[key] = [...existing[key], ...history]; } localStorage.setItem('priceHistory', JSON.stringify(existing)); loadPriceHistory(); } renderSavedList(); showToast('Importado', 'success'); setTimeout(()=>location.reload(), 1000); } catch { showToast('Error al importar', 'error'); } }; reader.readAsText(file); event.target.value = ''; }

        function loadCompanyData() { const saved = localStorage.getItem('companyData'); if (saved) { companyData = JSON.parse(saved); document.getElementById('empresaNombre').value = companyData.nombre || ''; document.getElementById('empresaCuit').value = companyData.cuit || ''; document.getElementById('empresaDireccion').value = companyData.direccion || ''; document.getElementById('empresaTelefono').value = companyData.telefono || ''; document.getElementById('empresaEmail').value = companyData.email || ''; document.getElementById('empresaWeb').value = companyData.web || ''; if (companyData.logo) document.getElementById('logoPreview').innerHTML = `<img src="${companyData.logo}" alt="Logo">`; } }
        function saveCompanyData() { companyData.nombre = document.getElementById('empresaNombre').value; companyData.cuit = document.getElementById('empresaCuit').value; companyData.direccion = document.getElementById('empresaDireccion').value; companyData.telefono = document.getElementById('empresaTelefono').value; companyData.email = document.getElementById('empresaEmail').value; companyData.web = document.getElementById('empresaWeb').value; localStorage.setItem('companyData', JSON.stringify(companyData)); }
        
        // Protecci칩n Logo > 1MB
        function handleLogoUpload(event) { 
            const file = event.target.files[0]; if (!file) return; 
            if (file.size > 1024 * 1024) { alert("El logo es demasiado grande (M치ximo 1MB)"); return; }
            
            const reader = new FileReader(); 
            reader.onload = (e) => { 
                companyData.logo = e.target.result; document.getElementById('logoPreview').innerHTML = `<img src="${companyData.logo}" alt="Logo">`; saveCompanyData(); 
            }; 
            reader.readAsDataURL(file); 
        }
        function removeLogo() { companyData.logo = null; document.getElementById('logoPreview').innerHTML = '<span class="logo-preview-placeholder">Logo</span>'; saveCompanyData(); }

        function loadPriceHistory() { const saved = localStorage.getItem('priceHistory'); if (saved) priceHistory = JSON.parse(saved); }
        function savePriceHistory() { localStorage.setItem('priceHistory', JSON.stringify(priceHistory)); }
        function addToPriceHistory(itemName, oldPrice, newPrice) { if (!priceHistory[itemName]) priceHistory[itemName] = []; priceHistory[itemName].push({ date: new Date().toISOString(), oldPrice, newPrice }); savePriceHistory(); }
        function updateAllPrices() { const allItems = [...state.materiales, ...state.telas, ...state.jornadas, ...state.fletes]; const today = new Date().toISOString(); allItems.forEach(item => { if (item.precio > 0) { if (!priceHistory[item.desc]) priceHistory[item.desc] = []; const lastEntry = priceHistory[item.desc][priceHistory[item.desc].length - 1]; if (!lastEntry || lastEntry.newPrice !== item.precio) priceHistory[item.desc].push({ date: today, oldPrice: lastEntry?.newPrice || 0, newPrice: item.precio }); } }); savePriceHistory(); showToast('Precios registrados', 'success'); }
        function openPriceHistoryModal() { renderPriceHistory(); openModal('priceHistoryModal'); }
        function renderPriceHistory() { const container = document.getElementById('priceHistoryList'); const searchTerm = document.getElementById('priceHistorySearch')?.value.toLowerCase() || ''; const entries = Object.entries(priceHistory).filter(([name]) => !searchTerm || name.toLowerCase().includes(searchTerm)).sort((a, b) => a[0].localeCompare(b[0])); if (entries.length === 0) { container.innerHTML = '<div class="empty-state"><p>No hay historial</p></div>'; return; } container.innerHTML = entries.map(([name, history]) => { const latest = history[history.length - 1]; const changeClass = latest.newPrice > latest.oldPrice ? 'price-up' : 'price-down'; const changePercent = latest.oldPrice > 0 ? Math.round(((latest.newPrice - latest.oldPrice) / latest.oldPrice) * 100) : 0; return `<div class="price-history-item"><div><strong>${escapeHtml(name)}</strong><div style="font-size:0.8rem;color:var(--charcoal-light);">${formatDate(latest.date.split('T')[0])} - ${history.length} cambios</div></div><div style="text-align: right;"><div>${formatCurrency(latest.newPrice)}</div>${latest.oldPrice > 0 ? `<span class="price-history-change ${changeClass}">${changePercent > 0 ? '+' : ''}${changePercent}%</span>` : ''}</div></div>`; }).join(''); }
        function filterPriceHistory() { renderPriceHistory(); }

        function calcMdf() { const ancho = parseFloat(document.getElementById('calcMdfAncho').value) || 0; const alto = parseFloat(document.getElementById('calcMdfAlto').value) || 0; const cant = parseInt(document.getElementById('calcMdfCant').value) || 1; const areaTotal = ancho * alto * cant; document.getElementById('calcMdfResult').textContent = Math.ceil(areaTotal / 4.758); document.getElementById('calcMdfM2').textContent = areaTotal.toFixed(2) + ' m'; }
        function calcTapacanto() { const ancho = parseFloat(document.getElementById('calcTapaAncho').value) || 0; const alto = parseFloat(document.getElementById('calcTapaAlto').value) || 0; const cant = parseInt(document.getElementById('calcTapaCant').value) || 1; const cantos = document.getElementById('calcTapaCantos').value; let metros = 0; if (cantos === '4') metros = (ancho * 2 + alto * 2) * cant; else if (cantos === '2h') metros = ancho * 2 * cant; else if (cantos === '2v') metros = alto * 2 * cant; else metros = Math.max(ancho, alto) * cant; document.getElementById('calcTapaResult').textContent = metros.toFixed(2) + ' m'; }
        function calcTela() { const ancho = parseFloat(document.getElementById('calcTelaAncho').value) || 0; const alto = parseFloat(document.getElementById('calcTelaAlto').value) || 0; const cant = parseInt(document.getElementById('calcTelaCant').value) || 1; const margen = (parseFloat(document.getElementById('calcTelaMargen').value) || 0) / 100; document.getElementById('calcTelaResult').textContent = ((ancho + margen * 2) * (alto + margen * 2) * cant).toFixed(2) + ' m'; }
        function calcLana() { const m2 = parseFloat(document.getElementById('calcLanaM2').value) || 0; const capas = parseInt(document.getElementById('calcLanaCapas').value) || 1; document.getElementById('calcLanaResult').textContent = Math.ceil((m2 * capas) / 18); }

        function exportPDF() {
            updateClientInfo();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pct = state.percentages;
            let y = 15;
            const margin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            doc.setFontSize(18); doc.setFont('helvetica', 'bold'); doc.setTextColor(114, 47, 55);
            doc.text(companyData.nombre || 'Herramientas Ac칰sticas', margin, y); y += 7;
            doc.setTextColor(74, 74, 74); doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            if (companyData.direccion) { doc.text(companyData.direccion, margin, y); y += 4; }
            if (companyData.telefono || companyData.email) { doc.text(`${companyData.telefono || ''} ${companyData.email ? '| ' + companyData.email : ''}`, margin, y); y += 4; }
            if (companyData.cuit) { doc.text(`CUIT: ${companyData.cuit}`, margin, y); y += 4; }

            doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.setTextColor(114, 47, 55);
            doc.text(`PRESUPUESTO ${state.clientInfo.numero || 'S/N'}`, pageWidth - margin, 20, { align: 'right' });
            doc.setFontSize(9); doc.setFont('helvetica', 'normal'); doc.setTextColor(74, 74, 74);
            doc.text(`Fecha: ${formatDate(state.clientInfo.fecha)}`, pageWidth - margin, 26, { align: 'right' });
            doc.text(`V치lido: ${state.clientInfo.validez || 30} d칤as`, pageWidth - margin, 31, { align: 'right' });

            y = Math.max(y, 40); doc.setDrawColor(114, 47, 55); doc.line(margin, y, pageWidth - margin, y); y += 5;

            doc.setFillColor(245, 240, 232); doc.rect(margin, y, pageWidth - margin * 2, 15, 'F'); y += 5;
            doc.setFontSize(8); doc.setTextColor(100, 100, 100); doc.text('CLIENTE', margin + 3, y); y += 5;
            doc.setFontSize(11); doc.setTextColor(45, 45, 45); doc.setFont('helvetica', 'bold');
            doc.text(`${state.clientInfo.nombre || ''} ${state.clientInfo.apellido || ''}`.trim() || 'Sin especificar', margin + 3, y);
            if (state.clientInfo.email) { doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.text(state.clientInfo.email, margin + 3, y + 5); }
            y += 18;

            const addSection = (title, items, color) => {
                const filtered = items.filter(i => i.cant > 0);
                if (filtered.length === 0) return 0;
                
                // MEJORA: SALTO DE PAGINA (Header Secci칩n)
                if (y > pageHeight - 30) { doc.addPage(); y = 20; }

                doc.setFillColor(...color); doc.rect(margin, y, pageWidth - margin * 2, 7, 'F');
                doc.setTextColor(255, 255, 255); doc.setFontSize(10); doc.setFont('helvetica', 'bold');
                doc.text(title, margin + 3, y + 5); y += 10;
                doc.setFillColor(245, 240, 232); doc.rect(margin, y, pageWidth - margin * 2, 6, 'F');
                doc.setTextColor(100, 100, 100); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('Descripci칩n', margin + 3, y + 4); doc.text('Cant.', margin + 95, y + 4);
                doc.text('$ Unit.', margin + 115, y + 4); doc.text('$ Total', margin + 145, y + 4); y += 8;
                let sectionTotal = 0;
                doc.setFont('helvetica', 'normal'); doc.setTextColor(45, 45, 45); doc.setFontSize(9);
                filtered.forEach(item => {
                    // MEJORA: SALTO DE PAGINA (Filas)
                    if (y > pageHeight - 20) { doc.addPage(); y = 20; }
                    
                    const total = item.cant * item.precio; sectionTotal += total;
                    let desc = item.desc; if (desc.length > 45) desc = desc.substring(0, 42) + '...';
                    doc.text(desc, margin + 3, y); doc.text(item.cant.toString(), margin + 97, y);
                    doc.text(formatCurrency(item.precio), margin + 115, y); doc.text(formatCurrency(total), margin + 145, y);
                    doc.setDrawColor(230, 230, 230); doc.line(margin, y + 2, pageWidth - margin, y + 2); y += 6;
                });
                return sectionTotal;
            };

            const matTotal = addSection('MATERIALES', state.materiales, [114, 47, 55]);
            const telaTotal = addSection('TELAS', state.telas, [139, 157, 119]);
            const jornadaTotal = addSection('JORNADAS', state.jornadas, [196, 120, 90]);
            const fleteTotal = addSection('FLETES', state.fletes, [45, 45, 45]);

            // MEJORA: Salto de P치gina para los Totales si no entran
            // Calculamos espacio requerido (aprox 60mm)
            if (y > pageHeight - 70) { doc.addPage(); y = 20; }
            y += 5; 

            const totalsX = pageWidth - margin - 80;
            const gastosMat = matTotal * (pct.gastosIndef / 100);
            const totalMat = matTotal + gastosMat;
            const mantenimiento = totalMat * (pct.mantenimiento / 100);
            const reposicion = totalMat * (pct.reposicion / 100);
            
            // Calculo correcto taller
            const cantidadJornadasTaller = state.jornadas.reduce((sum, j) => sum + (j.aplicaTaller ? j.cant : 0), 0);
            const gastosTaller = cantidadJornadasTaller * pct.gastoTaller;
            
            const subtotal = totalMat + mantenimiento + reposicion + gastosTaller + telaTotal + jornadaTotal;
            const ganancia = subtotal * (pct.ganancia / 100);
            const totalFinal = subtotal + ganancia + fleteTotal;

            doc.setFontSize(9); doc.setFont('helvetica', 'normal'); doc.setTextColor(74, 74, 74);
            const addTotalRow = (label, value, bold = false) => { if (bold) { doc.setFont('helvetica', 'bold'); doc.setTextColor(45, 45, 45); } doc.text(label, totalsX, y); doc.text(formatCurrency(value), pageWidth - margin, y, { align: 'right' }); doc.setFont('helvetica', 'normal'); doc.setTextColor(74, 74, 74); y += 5; };

            addTotalRow('Subtotal Materiales', matTotal); addTotalRow(`Gastos Indef. (${pct.gastosIndef}%)`, gastosMat);
            addTotalRow('Total Materiales', totalMat, true); addTotalRow(`Mantenimiento (${pct.mantenimiento}%)`, mantenimiento);
            addTotalRow(`Reposici칩n (${pct.reposicion}%)`, reposicion); addTotalRow('Gastos Taller', gastosTaller);
            addTotalRow('Total Telas', telaTotal); addTotalRow('Total Jornadas', jornadaTotal);
            y += 2; doc.setDrawColor(200, 200, 200); doc.line(totalsX, y, pageWidth - margin, y); y += 5;
            addTotalRow('Subtotal', subtotal, true); addTotalRow(`Ganancia (${pct.ganancia}%)`, ganancia);
            addTotalRow('Fletes', fleteTotal); y += 3;

            doc.setFillColor(114, 47, 55); doc.rect(totalsX - 5, y - 3, pageWidth - margin - totalsX + 10, 10, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(11); doc.setFont('helvetica', 'bold');
            doc.text('TOTAL', totalsX, y + 4); doc.text(formatCurrency(totalFinal), pageWidth - margin, y + 4, { align: 'right' });
            y += 20;

            if (state.clientInfo.observaciones) {
                // Check Observaciones page
                if (y > pageHeight - 30) { doc.addPage(); y = 20; }
                
                doc.setFillColor(245, 240, 232); doc.rect(margin, y, pageWidth - margin * 2, 5, 'F');
                doc.setTextColor(100, 100, 100); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('OBSERVACIONES', margin + 3, y + 3.5); y += 8;
                doc.setFont('helvetica', 'normal'); doc.setTextColor(74, 74, 74); doc.setFontSize(9);
                const lines = doc.splitTextToSize(state.clientInfo.observaciones, pageWidth - margin * 2 - 6);
                doc.text(lines, margin + 3, y);
            }

            doc.save(state.clientInfo.numero ? `Presupuesto-${state.clientInfo.numero}.pdf` : `Presupuesto-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF generado', 'success');
        }

        function showToast(message, type = 'success') { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = `toast ${type} show`; setTimeout(() => { toast.classList.remove('show'); }, 3000); }
        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); }); });
        init();
    </script>
</body>
</html>